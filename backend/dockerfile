# ---- Build stage ----
FROM golang:1.22 as builder

WORKDIR /app

# Go mod first pour le cache
COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -o clicker-backend main.go

# ---- Run stage ----
FROM alpine:3.19

WORKDIR /app

# Certificats + client postgres pour pg_isready
RUN apk add --no-cache ca-certificates postgresql-client

# Copier le binaire
COPY --from=builder /app/clicker-backend /app/clicker-backend

# Copier le script d'attente DB
# (assure-toi que wait-for-db.sh est bien à la racine du dossier backend)   
COPY wait-for-db.sh /app/wait-for-db.sh

# Corriger les fins de lignes Windows + rendre exécutable
RUN sed -i 's/\r$//' /app/wait-for-db.sh && chmod +x /app/wait-for-db.sh

EXPOSE 8081
ENV PORT=8081

# On passe par "sh" explicitement, avec des chemins absolus
CMD ["sh", "/app/wait-for-db.sh", "db", "/app/clicker-backend"]
